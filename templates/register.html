<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register — E2E Messaging Demo</title>
  <!-- Minimal styling; replace with your CSS file if you have one -->
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    form { border: 1px solid #e1e1e1; padding: 1rem; border-radius: 6px; background:#fff; }
    label { display:block; margin: 0.5rem 0 0.25rem; font-weight: 600; }
    input[type="text"], input[type="password"], input[type="email"] { width:100%; padding:0.5rem; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
    .muted { color:#666; font-size:0.9rem; }
    .row { margin-bottom: 0.75rem; }
    .error { color:#b00020; margin:0.5rem 0; }
    .meter { height:10px; background:#eee; border-radius:6px; overflow:hidden; margin-top:0.25rem; }
    .meter > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff4d4f,#ffb84d,#4cd964); transition: width .2s ease; }
    button { padding:0.6rem 1rem; border-radius:4px; border:0; background:#007bff; color:#fff; cursor:pointer; }
    button[disabled] { background:#9bbcfb; cursor:not-allowed; }
    .note { margin-top:0.5rem; font-size:0.9rem; color:#444; }
  </style>
</head>
<body>
  <h1>Create account</h1>

  {# Flash messages (Flask's get_flashed_messages) #}
  {% with messages = get_flashed_messages(category_filter=["error"]) %}
    {% if messages %}
      <div class="error" role="alert">
        {% for msg in messages %}{{ msg }}<br>{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% with messages = get_flashed_messages(category_filter=["success"]) %}
    {% if messages %}
      <div class="note" role="status">
        {% for msg in messages %}{{ msg }}<br>{% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Registration form posts to /register (server should verify and create account) -->
  <form id="register-form" method="post" action="{{ url_for('register') }}" autocomplete="off" novalidate>
    {# CSRF - either pass a csrf_token variable to the template or use Flask-WTF form.hidden_tag() #}
    {% if csrf_token is defined %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    {% elif form is defined %}
      {{ form.hidden_tag() }}
    {% endif %}

    <div class="row">
      <label for="username">Username</label>
      <input id="username" name="username" type="text" required maxlength="150" pattern="[A-Za-z0-9_.-]{3,150}"
             title="3–150 characters. Letters, numbers, underscore, hyphen or dot." autofocus>
      <div class="muted">3–150 characters. Allowed: letters, numbers, underscore, dot, hyphen.</div>
    </div>

    <div class="row">
      <label for="email">Email (optional)</label>
      <input id="email" name="email" type="email" placeholder="you@example.com" maxlength="254" autocapitalize="off">
      <div class="muted">Used only for account recovery/notifications if you enable it.</div>
    </div>

    <div class="row">
      <label for="password">Password</label>
      <input id="password" name="password" type="password" minlength="12" required
             autocomplete="new-password" aria-describedby="pw-requirements">
      <div id="pw-requirements" class="muted">Minimum 12 characters recommended. Use a passphrase or long random password.</div>

      <div class="meter" aria-hidden="true">
        <i id="pw-meter"></i>
      </div>
      <div id="pw-strength" class="muted" aria-live="polite"></div>
    </div>

    <div class="row">
      <label for="confirm_password">Confirm password</label>
      <input id="confirm_password" name="confirm_password" type="password" minlength="12" required autocomplete="new-password">
      <div id="confirm-note" class="muted"></div>
    </div>

    <div class="row">
      <label>
        <input id="show_pw" type="checkbox" /> Show passwords
      </label>
    </div>

    <div class="row">
      <button id="submit" type="submit" disabled>Create account</button>
      <div class="note">By creating an account you agree to handle data responsibly. For demo use only.</div>
    </div>
  </form>

  <script>
    // Client-side helpers: basic strength estimation and validation UI.
    // IMPORTANT: always validate server-side; client-side JS is only for UX.

    const password = document.getElementById('password');
    const confirm = document.getElementById('confirm_password');
    const meter = document.getElementById('pw-meter');
    const strengthText = document.getElementById('pw-strength');
    const confirmNote = document.getElementById('confirm-note');
    const submitBtn = document.getElementById('submit');
    const showPw = document.getElementById('show_pw');

    function scorePassword(pw) {
      // naive scoring: length and variety of character classes
      if (!pw) return 0;
      let score = 0;
      if (pw.length >= 12) score += 2;
      if (pw.length >= 16) score += 1;
      if (/[a-z]/.test(pw)) score++;
      if (/[A-Z]/.test(pw)) score++;
      if (/[0-9]/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;
      return Math.min(score, 8);
    }

    function updateMeter() {
      const s = scorePassword(password.value);
      const pct = Math.round((s/8)*100);
      meter.style.width = pct + '%';
      let label = 'Very weak';
      if (s >= 6) label = 'Strong';
      else if (s >= 4) label = 'Moderate';
      else if (s >= 2) label = 'Weak';
      strengthText.textContent = label + (password.value ? ` (${password.value.length} chars)` : '');
      // color gradient by inline style change
      if (s >= 6) meter.style.background = 'linear-gradient(90deg,#4cd964,#7be495)';
      else if (s >= 4) meter.style.background = 'linear-gradient(90deg,#ffb84d,#ffd27a)';
      else meter.style.background = 'linear-gradient(90deg,#ff4d4f,#ff8a8a)';
    }

    function updateConfirm() {
      if (!confirm.value) { confirmNote.textContent = ''; return; }
      if (password.value === confirm.value) {
        confirmNote.textContent = 'Passwords match';
        confirmNote.style.color = '#0a0';
      } else {
        confirmNote.textContent = 'Passwords do not match';
        confirmNote.style.color = '#b00020';
      }
    }

    function validateFormUI() {
      const pwOk = scorePassword(password.value) >= 3 && password.value.length >= 12;
      const match = password.value && (password.value === confirm.value);
      submitBtn.disabled = !(pwOk && match && document.getElementById('username').checkValidity());
    }

    password.addEventListener('input', () => { updateMeter(); updateConfirm(); validateFormUI(); });
    confirm.addEventListener('input', () => { updateConfirm(); validateFormUI(); });
    document.getElementById('username').addEventListener('input', validateFormUI);
    showPw.addEventListener('change', (e) => {
      const t = e.target.checked ? 'text' : 'password';
      password.type = t;
      confirm.type = t;
    });

    // Prevent accidental submission with invalid HTML5 constraints (optional)
    document.getElementById('register-form').addEventListener('submit', (e) => {
      // If you want extra client-side checks you can perform them here.
      if (submitBtn.disabled) {
        e.preventDefault();
      }
      // Do NOT send plaintext passwords to logs or store them in localStorage/sessionStorage.
    });

    // Initialize meter in case of browser autofill/populate
    updateMeter();
    updateConfirm();
    validateFormUI();
  </script>
</body>
</html>
